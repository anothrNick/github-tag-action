name: Test
# This workflow tests the tag action and can be used on PRs to detect (some) breaking changes.

on:
  pull_request:
    types:
      - opened
      - edited
      - reopened
      - synchronize

permissions:
  pull-requests: write
  checks: write
  contents: read

jobs:
  test-action:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: "0"

      - name: Test action main
        id: test_main
        uses: ./
        env:
          DRY_RUN: true
          WITH_V: true
          VERBOSE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test action pre-release
        id: test_pre
        uses: ./
        env:
          DRY_RUN: true
          WITH_V: true
          PRERELEASE: true
          PRERELEASE_SUFFIX: test
          VERBOSE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if the tag would have been created
        shell: bash
        run: |
          chmod +x .github/workflows/scripts/tag_check.sh
          ./.github/workflows/scripts/tag_check.sh "${{ steps.test_main.outputs.old_tag }}" "${{ steps.test_main.outputs.new_tag }}" "${{ steps.test_main.outputs.part }}" "${{ steps.test_pre.outputs.old_tag }}" "${{ steps.test_pre.outputs.new_tag }}" "${{ steps.test_pre.outputs.part }}"
