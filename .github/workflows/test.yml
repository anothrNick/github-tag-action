name: Test
# This workflow tests the tag action and can be used on PRs to detect (some) breaking changes.

on:
  pull_request:
    types:
      - opened
      - edited
      - reopened
      - synchronize
  workflow_dispatch:

permissions:
  pull-requests: write
  checks: write
  contents: read

jobs:
  default-bump-undefined:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: "0"
      - name: Create test repo
        shell: bash
        run: |
          .github/workflows/tests/default-bump.sh
      - name: Create a tag
        id: create-tag
        uses: ./
        env:
          DRY_RUN: true
          VERBOSE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE: test-repo
      - name: Check if the tag would have been created
        shell: bash
        run: |
          .github/workflows/tests/_assert.sh ${{ steps.create-tag.outputs.new_tag }} "1.2.0"
  default-bump-set-to-patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: "0"
      - name: Create test repo
        shell: bash
        run: |
          .github/workflows/tests/default-bump.sh
      - name: Create a tag
        id: create-tag
        uses: ./
        env:
          DRY_RUN: true
          VERBOSE: true
          DEFAULT_BUMP: patch
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE: test-repo
      - name: Check if the tag would have been created
        shell: bash
        run: |
          .github/workflows/tests/_assert.sh ${{ steps.create-tag.outputs.new_tag }} "1.1.2"
  default-bump-set-to-major:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: "0"
      - name: Create test repo
        shell: bash
        run: |
          .github/workflows/tests/default-bump.sh
      - name: Create a tag
        id: create-tag
        uses: ./
        env:
          DRY_RUN: true
          VERBOSE: true
          DEFAULT_BUMP: major
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE: test-repo
      - name: Check if the tag would have been created
        shell: bash
        run: |
          .github/workflows/tests/_assert.sh ${{ steps.create-tag.outputs.new_tag }} "2.0.0"
  several-commits-default-bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: "0"
      - name: Create test repo
        shell: bash
        run: |
          .github/workflows/tests/several_commits_default_bump.sh
      - name: Create a tag
        id: create-tag
        uses: ./
        env:
          DRY_RUN: true
          VERBOSE: true
          DEFAULT_BUMP: major
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE: test-repo
          USE_LAST_COMMIT_ONLY: false
      - name: Check if the tag would have been created
        shell: bash
        run: |
          .github/workflows/tests/_assert.sh ${{ steps.create-tag.outputs.new_tag }} "6.0.0"
  several-commits-mix-tagged-and-not-tagged-commits:
    name: "Several commits: if tagged and not tagged commits present then only tagged are taken into account"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: "0"
      - name: Create test repo
        shell: bash
        run: |
          .github/workflows/tests/several_mixed_tagged_and_not_tagged_commits.sh
      - name: Create a tag
        id: create-tag
        uses: ./
        env:
          DRY_RUN: true
          VERBOSE: true
          DEFAULT_BUMP: major
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE: test-repo
          USE_LAST_COMMIT_ONLY: false
      - name: Check if the tag would have been created
        shell: bash
        run: |
          .github/workflows/tests/_assert.sh ${{ steps.create-tag.outputs.new_tag }} "1.3.0"
  several-commits-major-takes-precedence-over-path:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: "0"
      - name: Create test repo
        shell: bash
        run: |
          .github/workflows/tests/several_commits_major_takes_precedence_over_path.sh
      - name: Create a tag
        id: create-tag
        uses: ./
        env:
          DRY_RUN: true
          VERBOSE: true
          DEFAULT_BUMP: major
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE: test-repo
          USE_LAST_COMMIT_ONLY: false
      - name: Check if the tag would have been created
        shell: bash
        run: |
          .github/workflows/tests/_assert.sh ${{ steps.create-tag.outputs.new_tag }} "1.4.0"
  custom-tag-with-prefix-is-bumped-if-tag-with-given-prefix-already-exists:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: "0"
      - name: Create test repo
        shell: bash
        run: |
          .github/workflows/tests/custom_tag_with_prefix_is_bumped_if_tag_with_given_prefix_already_exists.sh
      - name: Create a tag
        id: create-tag
        uses: ./
        env:
          DRY_RUN: true
          VERBOSE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE: test-repo
          PREFIX: prefix-
      - name: Check if the tag would have been created
        shell: bash
        run: |
          .github/workflows/tests/_assert.sh ${{ steps.create-tag.outputs.new_tag }} "prefix-1.1.2"
  custom-tag-of-initial-value-with-prefix-is-created-if-tag-with-given-prefix-does-not-exist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: "0"
      - name: Create test repo
        shell: bash
        run: |
          .github/workflows/tests/custom_tag_of_initial_value_with_prefix_is_created_if_tag_with_given_prefix_does_not_exist.sh
      - name: Create a tag
        id: create-tag
        uses: ./
        env:
          DRY_RUN: true
          VERBOSE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE: test-repo
          # PREFIX: prefix-
          # INITIAL_VERSION: 5.6.7
      - name: Check if the tag would have been created
        shell: bash
        run: |
          .github/workflows/tests/_assert.sh ${{ steps.create-tag.outputs.new_tag }} "prefix-1.1.0"
